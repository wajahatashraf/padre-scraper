<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padre.gg Tweet Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            border-left: 1px solid #2f3336;
            border-right: 1px solid #2f3336;
        }

        /* Loading States */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .loading-screen.hidden {
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(29, 155, 240, 0.3);
            border-radius: 50%;
            border-top-color: #1d9bf0;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #71767b;
            font-size: 16px;
            margin-top: 10px;
        }

        .loading-dots {
            display: inline-block;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #2f3336;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .logo {
            color: #1d9bf0;
            font-size: 24px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #71767b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #00ba7c;
        }

        .status-dot.stopped {
            background-color: #f4212e;
        }

        /* Control Panel */
        .control-panel {
            padding: 16px;
            border-bottom: 1px solid #2f3336;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #000;
        }

        .stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #71767b;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 9999px;
            border: none;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: #1d9bf0;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a8cd8;
        }

        .btn-primary:disabled {
            background-color: #1a8cd8;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-danger {
            background-color: #f4212e;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d11a27;
        }

        .btn-secondary {
            background-color: transparent;
            color: #1d9bf0;
            border: 1px solid #536471;
        }

        .btn-secondary:hover {
            background-color: rgba(29, 155, 240, 0.1);
        }

        /* Tweets Container */
        .tweets-container {
            position: relative;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #71767b;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #2f3336;
            opacity: 0.5;
        }

        /* Tweet Card */
        .tweet-card {
            padding: 16px;
            border-bottom: 1px solid #2f3336;
            transition: background-color 0.2s;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tweet-card:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .tweet-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-main {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
            flex-wrap: wrap;
        }

        .name {
            font-weight: 700;
            font-size: 15px;
        }

        .verified {
            color: #1d9bf0;
            font-size: 14px;
        }

        .username {
            color: #71767b;
            font-size: 15px;
        }

        .timestamp {
            color: #71767b;
            font-size: 14px;
            margin-left: auto;
        }

        .tweet-type {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(29, 155, 240, 0.1);
            color: #1d9bf0;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .replying-to {
            color: #71767b;
            font-size: 14px;
            margin-bottom: 8px;
            padding-left: 60px;
        }

        .replying-to a {
            color: #1d9bf0;
            text-decoration: none;
            font-weight: 500;
        }

        .replying-to a:hover {
            text-decoration: underline;
        }

        .tweet-content {
            margin: 12px 0;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .tweet-stats {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2f3336;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #71767b;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .stat:hover {
            opacity: 0.8;
        }

        .stat i {
            font-size: 14px;
        }

        .stat.likes i { color: #f91880; }
        .stat.retweets i { color: #00ba7c; }
        .stat.replies i { color: #1d9bf0; }
        .stat.bookmarks i { color: #7856ff; }

        /* Subtweet and Quoted Tweet Styles */
        .subtweet, .quoted-tweet {
            margin: 12px 0;
            padding: 12px;
            border: 1px solid #2f3336;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.02);
            transition: background-color 0.2s;
        }

        .subtweet:hover, .quoted-tweet:hover {
            background-color: rgba(255, 255, 255, 0.04);
        }

        .subtweet-header, .quoted-tweet-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .subtweet-header i, .quoted-tweet-header i {
            color: #71767b;
            font-size: 12px;
        }

        .subtweet-author, .quoted-tweet-author {
            color: #71767b;
            font-size: 14px;
            text-decoration: none;
        }

        .subtweet-author span:first-child, .quoted-tweet-author span:first-child {
            font-weight: 500;
            color: #e7e9ea;
        }

        .subtweet-author span:last-child, .quoted-tweet-author span:last-child {
            color: #71767b;
        }

        .subtweet-content, .quoted-tweet-content {
            color: #e7e9ea;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Hover effects */
        .tweet-header .name:hover,
        .tweet-header .username:hover {
            text-decoration: underline;
        }

        .timestamp:hover {
            text-decoration: underline;
        }

        /* New Tweets Banner */
        .new-tweets-banner {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1d9bf0;
            color: white;
            padding: 10px 20px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
            border: none;
        }

        .new-tweets-banner:hover {
            background-color: #1a8cd8;
        }

        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 70px; opacity: 1; }
        }

        /* Scroll to top */
        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #1d9bf0;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .scroll-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .scroll-top:hover {
            background-color: #1a8cd8;
            transform: translateY(-2px);
        }

        /* Connection Status */
        .connection-status {
            text-align: center;
            padding: 20px;
            color: #71767b;
            font-size: 14px;
        }

        /* Tweet Card Click Area */
        .tweet-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            cursor: pointer;
        }

        /* Media Queries */
        @media (max-width: 600px) {
            .app-container {
                border: none;
            }

            .header, .control-panel {
                padding: 12px;
            }

            .tweet-card {
                padding: 12px;
            }

            .control-buttons {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen (Initial) -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
            <h1>Padre.gg Tweet Monitor</h1>
            <p class="loading-text" id="loadingMessage">Ready to start monitoring</p>
            <button class="btn btn-primary" id="startButton" style="margin-top: 30px;">
                <i class="fas fa-play"></i> Start Monitoring
            </button>
        </div>

        <!-- Main Content (Hidden initially) -->
        <div id="mainContent" style="display: none;">
            <!-- Header -->
            <div class="header">
                <div class="header-title">
                    <i class="fab fa-twitter logo"></i>
                    <h1>Live Tweets</h1>
                </div>
                <div class="status-badge">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Stopped</span>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="stats">
                    <div class="stat-item">
                        <i class="fas fa-message"></i>
                        <span id="tweetCount">0</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-wifi"></i>
                        <span id="messageCount">0</span>
                    </div>
                </div>
                <div class="control-buttons">
                    <button class="btn btn-danger" id="stopBtn">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Tweets Container -->
            <div class="tweets-container">
                <div id="tweetsList">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-comment-slash"></i>
                        <h3>Waiting for tweets...</h3>
                        <p>Tweets will appear here once received</p>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="connection-status" id="connectionStatus">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>Connecting to WebSocket...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- New Tweets Banner -->
    <button class="new-tweets-banner" id="newTweetsBanner" style="display: none;">
        <i class="fas fa-sync-alt"></i>
        <span id="newTweetsCount">0 new tweets</span>
    </button>

    <!-- Scroll to Top Button -->
    <button class="scroll-top" id="scrollTopBtn">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
    // Global state
    let autoRefreshInterval = null;
    let currentTweetIds = new Set();
    let isScraperRunning = false;
    let isLoading = false;
    let hasData = false;
    let lastRefreshTime = Date.now();
    let tweetDataMap = new Map(); // Store tweet data for click handling

    // Format number
    function formatNumber(num) {
        num = parseInt(num) || 0;
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    // Escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Format tweet text
    function formatTweetText(text, mentions) {
        if (!text) return '';
        let formatted = escapeHtml(text);

        // Replace URLs
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        formatted = formatted.replace(urlRegex, url =>
            `<a href="${url}" target="_blank" style="color: #1d9bf0; text-decoration: none;">${url}</a>`
        );

        // Replace mentions
        if (mentions) {
            mentions.forEach(mention => {
                const username = mention.replace('@', '');
                const mentionRegex = new RegExp(`@${username}\\b`, 'gi');
                formatted = formatted.replace(
                    mentionRegex,
                    `<a href="https://x.com/${username}" target="_blank" style="color: #1d9bf0; font-weight: 500; text-decoration: none;">@${username}</a>`
                );
            });
        }

        return formatted;
    }

    // Create tweet element
    function createTweetElement(tweet) {
        // Store tweet data for click handling
        tweetDataMap.set(tweet.id, tweet);

        const isReply = tweet.type === 'REPLY';
        const isRetweet = tweet.type === 'RETWEET';
        const isQuote = tweet.type === 'QUOTE';

        let typeBadge = '';
        if (isReply) typeBadge = '<span class="tweet-type">Reply</span>';
        else if (isRetweet) typeBadge = '<span class="tweet-type">Retweet</span>';
        else if (isQuote) typeBadge = '<span class="tweet-type">Quote</span>';

        return `
            <div class="tweet-card" data-id="${tweet.id}">
                ${tweet.replying_to ? `
                    <div class="replying-to">
                        <i class="fas fa-reply" style="margin-right: 4px;"></i>
                        Replying to
                        <a href="https://x.com/${tweet.replying_to.username}" target="_blank" style="text-decoration: none;">
                            @${escapeHtml(tweet.replying_to.username)}
                        </a>
                    </div>
                ` : ''}

                <div class="tweet-header">
                    <a href="https://x.com/${tweet.author.username}" target="_blank" style="text-decoration: none;">
                        <img src="${tweet.author.avatar || 'https://abs.twimg.com/sticky/default_profile_images/default_normal.png'}"
                             alt="${tweet.author.name}"
                             class="avatar">
                    </a>
                    <div class="user-info">
                        <div class="user-main">
                            <a href="https://x.com/${tweet.author.username}" target="_blank" style="text-decoration: none; color: inherit;">
                                <span class="name">${escapeHtml(tweet.author.name)}</span>
                            </a>
                            ${tweet.author.verified ? '<i class="fas fa-check-circle verified"></i>' : ''}
                            <a href="https://x.com/${tweet.author.username}" target="_blank" style="text-decoration: none;">
                                <span class="username">@${escapeHtml(tweet.author.username)}</span>
                            </a>
                            ${typeBadge}
                            <a href="${tweet.twitter_url}" target="_blank" class="timestamp" style="text-decoration: none;">
                                ${escapeHtml(tweet.relative_time || tweet.formatted_time)}
                            </a>
                        </div>
                    </div>
                </div>

                ${tweet.subtweet && tweet.subtweet.content ? `
                    <div class="subtweet">
                        <div class="subtweet-header">
                            <i class="fas fa-comment"></i>
                            <a href="https://x.com/${tweet.subtweet.author.username}" target="_blank" class="subtweet-author">
                                <span>${escapeHtml(tweet.subtweet.author.name)}</span>
                                <span>@${escapeHtml(tweet.subtweet.author.username)}</span>
                            </a>
                        </div>
                        <div class="subtweet-content">
                            ${formatTweetText(tweet.subtweet.content, [])}
                        </div>
                    </div>
                ` : ''}

                <div class="tweet-content">
                    ${formatTweetText(tweet.content.text, tweet.content.mentions)}
                </div>

                ${tweet.quoted ? `
                    <div class="quoted-tweet">
                        <div class="quoted-tweet-header">
                            <i class="fas fa-quote-left"></i>
                            <a href="https://x.com/${tweet.quoted.username}" target="_blank" class="quoted-tweet-author">
                                <span>Quoting @${escapeHtml(tweet.quoted.username)}</span>
                            </a>
                        </div>
                        ${tweet.quoted.text ? `
                            <div class="quoted-tweet-content">
                                ${formatTweetText(tweet.quoted.text, [])}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <div class="tweet-stats">
                    <a href="${tweet.twitter_url}" target="_blank" class="stat replies">
                        <i class="far fa-comment"></i>
                        <span>${formatNumber(tweet.stats.replies)}</span>
                    </a>
                    <a href="${tweet.twitter_url}" target="_blank" class="stat retweets">
                        <i class="fas fa-retweet"></i>
                        <span>${formatNumber(tweet.stats.retweets)}</span>
                    </a>
                    <a href="${tweet.twitter_url}" target="_blank" class="stat likes">
                        <i class="far fa-heart"></i>
                        <span>${formatNumber(tweet.stats.likes)}</span>
                    </a>
                    <a href="${tweet.twitter_url}" target="_blank" class="stat bookmarks">
                        <i class="far fa-bookmark"></i>
                        <span>${formatNumber(tweet.stats.bookmarks)}</span>
                    </a>
                </div>
            </div>
        `;
    }

    // Update status
    async function updateStatus() {
        try {
            const response = await fetch('/status');
            const data = await response.json();

            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            isScraperRunning = data.running;

            if (data.running) {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Live';
            } else {
                statusDot.className = 'status-dot stopped';
                statusText.textContent = 'Stopped';
            }

            document.getElementById('tweetCount').textContent = data.tweet_count || 0;
            document.getElementById('messageCount').textContent = data.message_count || 0;

            return data;
        } catch (error) {
            console.error('Error updating status:', error);
            return null;
        }
    }

    // Load tweets
        // Load tweets
    async function loadTweets(showNewBanner = false) {
        if (isLoading) return;

        isLoading = true;
        const refreshBtn = document.getElementById('refreshBtn');
        const emptyState = document.getElementById('emptyState');
        const tweetsList = document.getElementById('tweetsList');
        const connectionStatus = document.getElementById('connectionStatus');

        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        refreshBtn.disabled = true;

        try {
            const response = await fetch('/messages');
            const data = await response.json();

            if (data.count > 0) {
                hasData = true;
                emptyState.style.display = 'none';
                connectionStatus.style.display = 'none';

                // Track new tweets
                const previousTweetIds = new Set(currentTweetIds);
                const newTweets = [];

                // FIRST: Identify new tweets from the server response
                data.messages.forEach(tweet => {
                    if (!previousTweetIds.has(tweet.id)) {
                        newTweets.push(tweet);
                    }
                });

                // Show new tweets banner
                if (newTweets.length > 0 && showNewBanner && previousTweetIds.size > 0) {
                    document.getElementById('newTweetsCount').textContent =
                        `${newTweets.length} new tweet${newTweets.length > 1 ? 's' : ''}`;
                    document.getElementById('newTweetsBanner').style.display = 'flex';
                }

                // Clear currentTweetIds and rebuild
                currentTweetIds.clear();

                // If we have new tweets, add them at the TOP
                if (newTweets.length > 0) {
                    // Add new tweets at the beginning (top of the list)
                    newTweets.forEach(tweet => {
                        currentTweetIds.add(tweet.id);
                        const tweetElement = createTweetElement(tweet);
                        tweetsList.insertAdjacentHTML('afterbegin', tweetElement);
                        tweetDataMap.set(tweet.id, tweet);
                    });

                    // Remove duplicates and keep only 100 tweets total
                    const allTweetElements = tweetsList.querySelectorAll('.tweet-card');
                    const seenIds = new Set();

                    for (let element of allTweetElements) {
                        const tweetId = element.dataset.id;
                        if (seenIds.has(tweetId)) {
                            element.remove();
                        } else {
                            seenIds.add(tweetId);
                        }
                    }

                    // Limit to 100 tweets
                    const keptTweets = tweetsList.querySelectorAll('.tweet-card');
                    if (keptTweets.length > 100) {
                        for (let i = 100; i < keptTweets.length; i++) {
                            keptTweets[i].remove();
                            const idToRemove = keptTweets[i].dataset.id;
                            currentTweetIds.delete(idToRemove);
                            tweetDataMap.delete(idToRemove);
                        }
                    }
                }

                // Also update currentTweetIds with ALL messages from server
                data.messages.forEach(tweet => {
                    currentTweetIds.add(tweet.id);
                });

            } else {
                emptyState.style.display = 'block';
                // Show connection status only if scraper is running but no data yet
                const status = await updateStatus();
                if (status && status.running) {
                    connectionStatus.style.display = 'block';
                    // Update waiting time message
                    const timeSinceStart = Math.floor((Date.now() - lastRefreshTime) / 1000);
                    connectionStatus.innerHTML = `
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>Waiting for tweets... (${timeSinceStart}s)</span>
                    `;
                } else {
                    connectionStatus.style.display = 'none';
                }
            }

            lastRefreshTime = Date.now();
        } catch (error) {
            console.error('Error loading tweets:', error);
            connectionStatus.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="color: #f4212e;"></i>
                <span>Connection error</span>
            `;
            connectionStatus.style.display = 'block';
        } finally {
            isLoading = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            refreshBtn.disabled = false;
        }
    }

    // Start scraper
    async function startScraper() {
        const startButton = document.getElementById('startButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const connectionStatus = document.getElementById('connectionStatus');

        startButton.disabled = true;
        startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
        loadingMessage.textContent = 'Starting scraper...';

        try {
            const response = await fetch('/start');
            const data = await response.json();

            loadingMessage.innerHTML = `
                <span style="color: #00ba7c;">
                    <i class="fas fa-check-circle"></i> ${data.message}
                </span><br>
                <small>Connecting to WebSocket...</small>
            `;

            // Wait a bit for scraper to initialize
            await new Promise(resolve => setTimeout(resolve, 3000));

            // Switch to main content
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // Show connecting status
            connectionStatus.style.display = 'block';
            connectionStatus.innerHTML = `
                <i class="fas fa-circle-notch fa-spin"></i>
                <span>Waiting for tweets...</span>
            `;

            // Start auto-refresh
            if (!autoRefreshInterval) {
                autoRefreshInterval = setInterval(async () => {
                    const status = await updateStatus();
                    if (status && status.running) {
                        await loadTweets(true);
                    }

                    // Update connection status message
                    if (status && status.running && currentTweetIds.size === 0) {
                        const timeSinceStart = Math.floor((Date.now() - lastRefreshTime) / 1000);
                        connectionStatus.innerHTML = `
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <span>Connected. Waiting for tweets... (${timeSinceStart}s)</span>
                        `;
                    }
                }, 3000);
            }

            // Initial load
            await updateStatus();
            await loadTweets(false);

        } catch (error) {
            console.error('Error starting scraper:', error);
            loadingMessage.innerHTML = `
                <span style="color: #f4212e;">
                    <i class="fas fa-exclamation-circle"></i> Failed to start scraper
                </span>
            `;
            startButton.disabled = false;
            startButton.innerHTML = '<i class="fas fa-redo"></i> Try Again';
            startButton.onclick = startScraper;
        }
    }

    // Stop scraper
    async function stopScraper() {
        if (confirm('Stop the scraper?')) {
            try {
                const response = await fetch('/stop');
                const data = await response.json();
                alert(data.message);

                // Clear intervals
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }

                // Reset state
                currentTweetIds.clear();
                tweetDataMap.clear();
                hasData = false;

                // Switch back to loading screen
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="loading-spinner"></div>
                    <h1>Padre.gg Tweet Monitor</h1>
                    <p class="loading-text">Scraper stopped</p>
                    <button class="btn btn-primary" id="startButton" style="margin-top: 30px;">
                        <i class="fas fa-play"></i> Start Monitoring
                    </button>
                `;

                // Re-attach event listener
                document.getElementById('startButton').addEventListener('click', startScraper);

            } catch (error) {
                console.error('Error stopping scraper:', error);
            }
        }
    }

    // Clear messages
    async function clearMessages() {
        if (confirm('Clear all tweets?')) {
            try {
                const response = await fetch('/clear');
                const data = await response.json();
                alert(data.message);
                currentTweetIds.clear();
                tweetDataMap.clear();
                await loadTweets();
                await updateStatus();
            } catch (error) {
                console.error('Error clearing messages:', error);
            }
        }
    }

    // Show new tweets
    function showNewTweets() {
        const banner = document.getElementById('newTweetsBanner');
        banner.style.display = 'none';

        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Scroll to top
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Toggle scroll button
    function toggleScrollButton() {
        const scrollBtn = document.getElementById('scrollTopBtn');
        if (window.scrollY > 300) {
            scrollBtn.classList.add('visible');
        } else {
            scrollBtn.classList.remove('visible');
        }
    }

    // Handle tweet card click
    function handleTweetClick(event) {
        // Don't trigger if clicking on a link
        if (event.target.tagName === 'A' || event.target.closest('a')) {
            return;
        }

        const tweetCard = event.target.closest('.tweet-card');
        if (tweetCard) {
            const tweetId = tweetCard.dataset.id;
            const tweet = tweetDataMap.get(tweetId);
            if (tweet && tweet.twitter_url) {
                window.open(tweet.twitter_url, '_blank');
            }
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Event listeners
        document.getElementById('startButton').addEventListener('click', startScraper);
        document.getElementById('stopBtn').addEventListener('click', stopScraper);
        document.getElementById('clearBtn').addEventListener('click', clearMessages);
        document.getElementById('refreshBtn').addEventListener('click', () => loadTweets(false));
        document.getElementById('newTweetsBanner').addEventListener('click', showNewTweets);
        document.getElementById('scrollTopBtn').addEventListener('click', scrollToTop);

        // Click handler for tweet cards
        document.addEventListener('click', handleTweetClick);

        // Scroll listener
        window.addEventListener('scroll', toggleScrollButton);

        // Initial toggle
        toggleScrollButton();
    });
    </script>
</body>
</html>